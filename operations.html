<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Operations Analytics – Oak & Linen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ================= FIREBASE ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBI3u_ZBnh-9IpLr6I4iUNG7IDo3hzV6ds",
      authDomain: "oak-n-linen-project.firebaseapp.com",
      projectId: "oak-n-linen-project",
      storageBucket: "oak-n-linen-project.firebasestorage.app",
      messagingSenderId: "783016997772",
      appId: "1:783016997772:web:2d9e352bdcc1ad4eba1ca9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

   onAuthStateChanged(auth, user => {
     const publicHeader = document.getElementById("publicHeader");

     const staffLinks = document.querySelectorAll(".staff-only");

     staffLinks.forEach(link => {
      link.style.display = user ? "inline-block" : "none";
     });


     if (user) {
      // Logged in
      publicHeader.style.display = "none";
      loginView.style.display = "none";
      dashboardView.style.display = "block";

      staffEmail.innerText = user.email;
      loadAnalytics();
    } else {
     // Logged out
     publicHeader.style.display = "block";
     loginView.style.display = "flex";
     dashboardView.style.display = "none";
   }

   if (user) {
          localStorage.setItem("siteMode", "internal");
          } else {
          localStorage.setItem("siteMode", "public");
       }
    });

    window.login = async () => {
      try {
        await signInWithEmailAndPassword(auth, email.value, password.value);
      } catch (e) {
        alert(e.message);
      }
    };

    window.registerStaff = async () => {
      try {
        await createUserWithEmailAndPassword(auth, email.value, password.value);
        alert("Staff registered.");
      } catch (e) {
        alert(e.message);
      }
    };

    window.resetPassword = async () => {
      try {
        await sendPasswordResetEmail(auth, email.value);
        alert("Password reset email sent.");
      } catch (e) {
        alert(e.message);
      }
    };

    window.logout = async () => {
      await signOut(auth);
    };

    function loadAnalytics() {
      const last24h = new Date(Date.now() - 24 * 60 * 60 * 1000);

      onSnapshot(collection(db, "orders"), snap => {
        let total = 0, delivered = 0, recent = 0;
        let revenue = 0, productsSold = 0;

        const status = { New:0, Preparing:0, "Out for Delivery":0, Delivered:0 };
        const resolution = { Return:0, Refund:0, Replacement:0 };
        const productMap = {};

        snap.forEach(doc => {
          const o = doc.data();
          total++;

          if (status[o.status] !== undefined) status[o.status]++;
          if (o.status === "Delivered") delivered++;
          if (o.createdAt?.toDate() >= last24h) recent++;
          if (o.totalAmount) revenue += o.totalAmount;

          if (o.items) {
            o.items.forEach(i => {
              productsSold += i.qty;
              productMap[i.product] = (productMap[i.product] || 0) + i.qty;
            });
          }

          if (resolution[o.resolution] !== undefined) resolution[o.resolution]++;
        });

        totalOrders.innerText = total;
        orders24h.innerText = recent;
        conversionRate.innerText = total ? Math.round((delivered / total) * 100) + "%" : "0%";
        totalSales.innerText = "€" + revenue.toFixed(2);
        products.innerText = productsSold;

        newOrders.innerText = status.New;
        preparingOrders.innerText = status.Preparing;
        deliveryOrders.innerText = status["Out for Delivery"];
        deliveredOrders.innerText = status.Delivered;

        returnCount.innerText = resolution.Return;
        refundCount.innerText = resolution.Refund;
        replacementCount.innerText = resolution.Replacement;

        drawBar("productChart", productMap);
        drawBar("statusChart", status);
      });
    }

    function drawBar(id, data) {
     const c = document.getElementById(id);
     const ctx = c.getContext("2d");

     ctx.clearRect(0, 0, c.width, c.height);

     // ✅ Match site font
     ctx.font = "12px Segoe UI, Arial";
     ctx.textAlign = "center";
     ctx.textBaseline = "top";

     const keys = Object.keys(data);
     const vals = Object.values(data);
     const max = Math.max(...vals, 1);

      const barWidth = 40;
      const gap = 90;              // ✅ more spacing between bars
      const startX = 60;
      const baseY = 165;

      keys.forEach((label, i) => {
      const value = vals[i];
      const height = (value / max) * 130;
      const x = startX + i * gap;

      // Bar
      ctx.fillStyle = "#2E5E4E";
      ctx.fillRect(x - barWidth / 2, baseY - height, barWidth, height);

      // Label (wrapped if long)
      ctx.fillStyle = "#2B2B2B";

      if (label.length > 12) {
      const words = label.split(" ");
      words.forEach((w, idx) => {
        ctx.fillText(w, x, baseY + 6 + idx * 14);
       });
      } else {
      ctx.fillText(label, x, baseY + 6);
     }
   });
  }

  </script>

  <!-- ================= STYLES ================= -->
  <style>
    * { box-sizing:border-box; font-family:"Segoe UI",Arial; }

    html, body { height:100%; }
    body {
      margin:0;
      background:#EFE7E1;
      color:#2B2B2B;
      display:flex;              /* ✅ makes header/login/footer stack properly */
      flex-direction:column;
      min-height:100vh;
    }

    header {
      background:#fff;
      border-bottom:4px solid #3E2723;
      padding:18px 36px;
      flex:0 0 auto;
    }

    .header-container {
      max-width:1200px;
      margin:auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .logo {
      display:flex;
      align-items:center;
      gap:10px;
      font-size:22px;
      font-weight:bold;
      color:#3E2723;
    }

    .logo-icon {
      width:40px;
      height:40px;
      background:#3E2723;
      color:#C6A75E;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    nav {
      display:flex;
      gap:24px;
      font-weight:600;
      align-items:center;
    }

    nav a {
      text-decoration:none;
      color:#2B2B2B;
      cursor:pointer;
    }

    /* ✅ KEY FIX: login view grows to fill the middle area */
    #loginView {
      flex:1 1 auto;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:40px 20px;         /* prevents weird top alignment on short screens */
    }

    .login-card {
      background:#fff;
      padding:40px;
      width:360px;
      border-radius:18px;
      box-shadow:0 12px 30px rgba(0,0,0,0.15);
      text-align:center;
    }

    input {
      width:100%;
      padding:12px;
      margin-bottom:14px;
      border-radius:8px;
      border:1px solid #ccc;
    }

    button {
      width:100%;
      padding:12px;
      border:none;
      border-radius:8px;
      background:#2E5E4E;
      color:#fff;
      font-weight:bold;
      cursor:pointer;
    }

    .links a {
      display:block;
      margin-top:8px;
      color:#2E5E4E;
      cursor:pointer;
    }

    #dashboardView { flex:1 1 auto; }

    main {
      max-width:1200px;
      margin:40px auto;
      padding:0 36px;
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:20px;
    }

    .card {
      background:#fff;
      padding:20px;
      border-radius:16px;
      box-shadow:0 8px 22px rgba(0,0,0,0.08);
      text-align:center;
    }

    .card span {
      font-size:28px;
      font-weight:bold;
      color:#2E5E4E;
    }

    canvas {
      margin-top:20px;
      background:#fff;
      border-radius:16px;
      padding:10px;
      box-shadow:0 8px 22px rgba(0,0,0,0.08);
    }

    /* ===== NAV ACTIVE & CLICK ===== */
nav a {
  padding: 6px 8px;
  border-radius: 8px;
  transition: background-color .2s ease, color .2s ease;
}

nav a.active {
  background: #2E5E4E; /* dark green */
  color: #fff;
}

nav a.clicked {
  animation: navBlink 0.4s ease;
}

@keyframes navBlink {
  0% {
    background: #2E5E4E;
    color: #fff;
  }
  50% {
    background: #C6A75E;
    color: #3E2723;
  }
  100% {
    background: #2E5E4E;
    color: #fff;
  }
}


    footer {
      background:#3E2723;
      color:#fff;
      text-align:center;
      padding:16px;
      font-size:14px;
      flex:0 0 auto;            /* ✅ footer stays at bottom */
    }

        footer {
      background:#3E2723;
      color:#EFE7E1;
      padding:50px 36px;
      font-size:14px;
    }

    .footer-container {
      max-width:1000px;
      margin:auto;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:30px;
      text-align:left;
    }

    .footer-section h4 {
      color:#C6A75E;
      margin-bottom:14px;
    }

    .footer-section a,
    .footer-section p {
      display:block;
      color:#EFE7E1;
      margin-bottom:8px;
      text-decoration:none;
    }

    .footer-section a:hover {
      text-decoration:underline;
    }

    .social a {
      margin-right:12px;
    }

    .footer-bottom {
      text-align:center;
      margin-top:30px;
      color:#D7CFC8;
      font-size:13px;
    }
    
  </style>
</head>

<body>

<!-- PUBLIC HEADER (LOGIN PAGE) -->
<header id="publicHeader">
  <div class="header-container">
    <div class="logo">
      <div class="logo-icon">OL</div>
      Oak & Linen
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="order-management.html">Order Management</a>
      <a href="operations.html">Operational Insights</a>
    </nav>
  </div>
</header>

<!-- LOGIN PAGE -->
<div id="loginView">
  <div class="login-card">
    <input id="email" placeholder="Staff Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <div class="links">
      <a onclick="registerStaff()">Register Staff</a>
      <a onclick="resetPassword()">Forgot Password?</a>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardView" style="display:none;">

  <!-- INTERNAL HEADER (ONLY ONE HEADER HERE) -->
  <header>
    <div class="header-container">
      <div class="logo">
        <div class="logo-icon">OL</div>
        Oak & Linen
      </div>
      <nav>
        <span>Logged in as <strong id="staffEmail"></strong></span>
        <a onclick="logout()">Logout</a>
      </nav>
    </div>
  </header>

  <main>
    <h1>Operations Analytics</h1>

    <div class="grid">
      <div class="card"><h3>Total Orders</h3><span id="totalOrders">0</span></div>
      <div class="card"><h3>Orders (Last 24h)</h3><span id="orders24h">0</span></div>
      <div class="card"><h3>Conversion Rate</h3><span id="conversionRate">0%</span></div>
      <div class="card"><h3>Total Sales</h3><span id="totalSales">€0</span></div>
      <div class="card"><h3>Products Sold</h3><span id="products">0</span></div>
    </div>

    <h2>Order Status Distribution</h2>
    <div class="grid">
      <div class="card"><h3>New</h3><span id="newOrders">0</span></div>
      <div class="card"><h3>Preparing</h3><span id="preparingOrders">0</span></div>
      <div class="card"><h3>Out for Delivery</h3><span id="deliveryOrders">0</span></div>
      <div class="card"><h3>Delivered</h3><span id="deliveredOrders">0</span></div>
    </div>

    <h2>Product Sales Volume</h2>
    <canvas id="productChart" width="500" height="260"></canvas>

    <h2>Returns / Refunds / Replacements</h2>
    <div class="grid">
      <div class="card"><h3>Returns</h3><span id="returnCount">0</span></div>
      <div class="card"><h3>Refunds</h3><span id="refundCount">0</span></div>
      <div class="card"><h3>Replacements</h3><span id="replacementCount">0</span></div>
    </div>

    <h2>Order Status Chart</h2>
    <canvas id="statusChart" width="500" height="220"></canvas>
  </main>
</div>

<footer>
  <div class="footer-container">

    <div class="footer-section">
      <h4>Oak & Linen</h4>
      <p>Crafted furniture. Intelligent operations.</p>
    </div>

    <div class="footer-section">
      <h4>Customer Care</h4>
      <a href="#">Delivery Information</a>
      <a href="#">Returns & Refund Policy</a>
      <a href="#">Warranty & Repairs</a>
    </div>

    <div class="footer-section">
      <h4>Contact</h4>
      <a href="mailto:support@oakandlinen.ie">support@oakandlinen.ie</a>
      <a href="tel:+35315550199">+353 1 555 0199</a>
    </div>

    <div class="footer-section">
      <h4>Connect</h4>
      <div class="social">
        <a href="#">Instagram</a>
        <a href="#">Facebook</a>
        <a href="#">LinkedIn</a>
      </div>
    </div>

  </div>
  <div class="footer-bottom">
    © 2025 Oak & Linen Furniture. All rights reserved.
  </div>
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const currentPage =
    location.pathname.split("/").pop() || "index.html";

  const navLinks = document.querySelectorAll("header nav a");

  navLinks.forEach(link => {
    const href = link.getAttribute("href");

    // Persistent active state
    if (href === currentPage) {
      link.classList.add("active");
    }

    // Click blink
    link.addEventListener("click", () => {
      navLinks.forEach(l => l.classList.remove("clicked"));
      link.classList.add("clicked");
    });
  });
});
</script>


</body>
</html>
