<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Portal – Oak & Linen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ================= FIREBASE ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      doc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBI3u_ZBnh-9IpLr6I4iUNG7IDo3hzV6ds",
      authDomain: "oak-n-linen-project.firebaseapp.com",
      projectId: "oak-n-linen-project",
      storageBucket: "oak-n-linen-project.firebasestorage.app",
      messagingSenderId: "783016997772",
      appId: "1:783016997772:web:2d9e352bdcc1ad4eba1ca9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ================= AUTH STATE =================
    onAuthStateChanged(auth, user => {
      document.getElementById("loginView").style.display = user ? "none" : "flex";
      document.getElementById("dashboardView").style.display = user ? "block" : "none";

      document.getElementById("loginHeader").style.display = user ? "none" : "block";
      document.getElementById("loginFooter").style.display = user ? "none" : "block";

      if (user) {
        document.getElementById("staffEmail").innerText = user.email;
        loadOrders();
      }
    });

    // ================= AUTH ACTIONS =================
    window.login = async () => {
      try {
        await signInWithEmailAndPassword(auth, email.value, password.value);
      } catch (e) {
        alert(e.message);
      }
    };

    window.registerStaff = async () => {
      try {
        await createUserWithEmailAndPassword(auth, email.value, password.value);
        alert("Staff account created. You can now log in.");
      } catch (e) {
        alert(e.message);
      }
    };

    window.resetPassword = async () => {
      try {
        await sendPasswordResetEmail(auth, email.value);
        alert("Password reset email sent.");
      } catch (e) {
        alert(e.message);
      }
    };

    window.logout = async () => {
      await signOut(auth);
    };

    // ================= ORDER MANAGEMENT =================
    function loadOrders() {
      const tbody = document.getElementById("ordersTable");

      onSnapshot(collection(db, "orders"), snap => {
        tbody.innerHTML = "";

        let total = 0, newO = 0, prep = 0, delivery = 0, issues = 0;

        snap.forEach(d => {
          const o = d.data();

          total++;
          if (o.status === "New") newO++;
          if (o.status === "Preparing") prep++;
          if (o.status === "Out for Delivery") delivery++;
          if (o.resolution) issues++;

          tbody.innerHTML += `
            <tr>
              <td>${d.id.slice(0,6)}</td>
              <td>${o.customerName}<br><small>${o.email}</small></td>
              <td>${o.items?.map(i => `${i.product} × ${i.qty}`).join("<br>") || "—"}</td>
              <td>€${o.totalAmount}</td>
              <td>
                <select onchange="updateStatus('${d.id}', this.value)">
                  ${["New","Preparing","Out for Delivery","Delivered","Closed"]
                    .map(s => `<option ${o.status===s?"selected":""}>${s}</option>`).join("")}
                </select>
              </td>
              <td>
                <select onchange="updateResolution('${d.id}', this.value)">
                  <option value="">None</option>
                  <option ${o.resolution==="Return"?"selected":""}>Return</option>
                  <option ${o.resolution==="Refund"?"selected":""}>Refund</option>
                  <option ${o.resolution==="Replacement"?"selected":""}>Replacement</option>
                </select>
              </td>
              <td>
                <textarea onblur="updateNotes('${d.id}', this.value)">${o.notes||""}</textarea>
              </td>
            </tr>
          `;
        });

        totalOrders.innerText = total;
        newOrders.innerText = newO;
        preparingOrders.innerText = prep;
        deliveryOrders.innerText = delivery;
        issueOrders.innerText = issues;
      });
    }

    window.updateStatus = (id,val) =>
      updateDoc(doc(db,"orders",id),{ status:val, updatedAt:serverTimestamp() });

    window.updateResolution = (id,val) =>
      updateDoc(doc(db,"orders",id),{ resolution:val, updatedAt:serverTimestamp() });

    window.updateNotes = (id,val) =>
      updateDoc(doc(db,"orders",id),{ notes:val, updatedAt:serverTimestamp() });
  </script>

  <!-- ================= STYLES ================= -->
  <style>
    * { box-sizing:border-box; font-family:"Segoe UI",Arial; }
    body { background:#EFE7E1; margin:0; color:#2B2B2B; }

    header {
      background:#fff;
      border-bottom:4px solid #3E2723;
      padding:18px 36px;
    }

    .header-container {
      max-width:1200px;
      margin:auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .logo {
      display:flex;
      align-items:center;
      gap:10px;
      font-size:22px;
      font-weight:bold;
      color:#3E2723;
      text-decoration:none;
    }

    .logo-icon {
      width:40px;
      height:40px;
      background:#3E2723;
      color:#C6A75E;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:6px;
    }

    nav {
      display:flex;
      gap:24px;
      font-weight:600;
    }

    nav a {
      text-decoration:none;
      color:#2B2B2B;
    }

    #loginView {
      min-height: calc(100vh - 140px);
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .login-card {
      background:#fff;
      padding:40px;
      width:380px;
      border-radius:18px;
      box-shadow:0 12px 30px rgba(0,0,0,0.15);
      text-align:center;
    }

    input {
      width:100%;
      padding:12px;
      margin-bottom:14px;
      border-radius:8px;
      border:1px solid #ccc;
    }

    button {
      width:100%;
      padding:12px;
      border:none;
      border-radius:8px;
      font-weight:bold;
      background:#2E5E4E;
      color:#fff;
      cursor:pointer;
    }

    .links a {
      display:block;
      margin-top:8px;
      font-size:14px;
      color:#2E5E4E;
      cursor:pointer;
    }

    footer {
      background:#3E2723;
      color:#EFE7E1;
      padding:30px;
      text-align:center;
      font-size:14px;
    }

    main {
      max-width:1400px;
      margin:40px auto;
      padding:0 36px;
    }

    .overview {
      background:#fff;
      padding:20px;
      border-radius:14px;
      box-shadow:0 8px 22px rgba(0,0,0,0.08);
      margin-bottom:30px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:16px;
      text-align:center;
    }

    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 10px 28px rgba(0,0,0,0.08);
    }

    th, td {
      padding:14px;
      border-bottom:1px solid #eee;
    }

    th { background:#3E2723; color:#fff; }
    small { color:#666; }
  </style>
</head>

<body>

<!-- LOGIN HEADER -->
<header id="loginHeader">
  <div class="header-container">
    <a href="index.html" class="logo">
      <div class="logo-icon">OL</div>
      Oak & Linen
    </a>
    <nav>
      <a href="index.html">Home</a>
      <a href="order-management.html">Order Management</a>
      <a href="operations.html">Operations</a>
    </nav>
  </div>
</header>

<!-- LOGIN VIEW -->
<div id="loginView">
  <div class="login-card">

    <input id="email" placeholder="Staff Email">
    <input id="password" type="password" placeholder="Password">

    <button onclick="login()">Login</button>
    <div class="links">
      <a onclick="registerStaff()">Register Staff</a>
      <a onclick="resetPassword()">Forgot Password?</a>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardView" style="display:none;">
  <header>
    <div class="header-container">
      <div class="logo">
        <div class="logo-icon">OL</div>
        Oak & Linen
      </div>
      <nav>
        <span>Logged in as: <strong id="staffEmail"></strong></span>
        <a href="#" onclick="logout()">Logout</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="overview">
      <div>Total Orders<br><strong id="totalOrders">0</strong></div>
      <div>New<br><strong id="newOrders">0</strong></div>
      <div>Preparing<br><strong id="preparingOrders">0</strong></div>
      <div>Out for Delivery<br><strong id="deliveryOrders">0</strong></div>
      <div>Issues<br><strong id="issueOrders">0</strong></div>
    </div>

    <h1>Order Management (Staff)</h1>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
          <th>Resolution</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody id="ordersTable"></tbody>
    </table>
  </main>
</div>

<!-- LOGIN FOOTER -->
<footer id="loginFooter">
  © 2025 Oak & Linen Furniture. All rights reserved.
<footer>
  
</body>
</html>
